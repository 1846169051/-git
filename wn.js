var status = -1;

var a1 = "#fItem/Cash/0501.img/05010101/effect/ladder/9#";//蘑菇
var a2 = "#fItem/Cash/0501.img/05010056/effect/walk1/5#";//"+z+"//草
var a3 = "#fItem/Cash/0501.img/05010056/effect/walk1/6#";//草
var a4 = "#fItem/Cash/0501.img/05010056/effect/walk1/7#";//"草"
var a5 = "#fMap/MapHelper.img/weather/knitsWithWarmWinter/9#";
var a6 = "#fMap/MapHelper.img/weather/balloon/1#";//"+z+"//美化
var a7 = "#fUI/CashShop/CSBeauty/hairColor/Disable/3#";//粉色蝴蝶
var a777 = "#fEffect/CharacterEff/1051366/1/0#";//粉色蝴蝶
var b0 = "#fEffect/CharacterEff/1051366/2/0#";//粉色蝴蝶
var a8 = "#fItem/Pet/5000221.img/sleep/5#";//"+z+"
var a9 = "#fItem/Pet/5000221.img/jump/0#";
var a99 = "#fItem/Pet/5000445.img/cry/1#";
var a999 = "#fItem/Pet/5000445.img/fly/0#";
var a998 = "#fItem/Pet/5000445.img/angry/4#";
var a10 = "#fItem/Pet/5000221.img/cry/0#";//"+z+"//美化

var a12 = "#fUI/UIWindow/Quest/icon5/1#";//"+z+"
var a13 = "#fUI/UIWindow.img/PvP/Scroll/enabled/next2#";
var a14 = "#fUI/UIWindow/Quest/icon5/1#";//"+z+"//美化
var a15 = "#fEffect/CharacterEff/1051296/1/0#";
var a16 = "#fUI/UIWindow/Quest/icon5/1#";//"+z+"
var a17 = "#fUI/UIWindow.img/PvP/Scroll/enabled/next2#";
var a18 = "#fUI/UIWindow/Quest/icon5/1#";//"+z+"//美化
var a19 = "#fEffect/CharacterEff/1051296/1/0#";
var a20 = "#fUI/UIWindow/Quest/icon5/1#";//"+z+"
var a21 = "#fUI/UIWindow.img/PvP/Scroll/enabled/next2#";
var a22 = "#fUI/UIWindow/Quest/icon5/1#";//"+z+"//美化
var a23 = "#fEffect/CharacterEff/1051296/1/0#";
var a0 = "#fMap/MapHelper.img/weather/snowbear/5#";//"+z+"
var a77 = "#fEffect/SetEff.img/245/effect/28#";
var a78 = "#fEffect/SetEff.img/245/effect/14#";
var b2 = "#fItem/Cash/0501.img/05010010/effect/default/0#";//雙人相框
var b3 = "#fUI/CashShop/CSEffect/lunaCrystal/0#"; //音符1
var b4 = "#fEffect/CharacterEff/1112949/3/0#"; //音符2
var b5 = "#fEffect/CharacterEff/1022223/6/0#"
var b6 = "#fEffect/CharacterEff/1022223/6/0#"
var b7 = "#v3801309#"
var b8 = "#fEffect/CharacterEff/1022223/9/0#"
var b9 = "#fItem/Cash/0501.img/05010056/effect/walk1/6#"; //小草
var b10 = "#fItem/Cash/0501.img/05010056/effect/walk1/4#"; //紅色小草
var a20 = "#fEffect/CharacterEff/1050334/1/0#"
var a11 = "#fUI/CashShop/CSBeauty/hairColor/Disable/3#";//粉色蝴蝶
var c11 = "#fEffect/CharacterEff/1082565/4/0#";//粉色兔子
var c12 = "#fUI/Basic/CheckBox1/1#";//粉色兔子8


var s1 = "#fUI/CashShop/CSBeauty/hairColor/Disable/0#"
var s1 = "#fUI/CashShop/CSBeauty/hairColor/Disable/1#"
var s2 = "#fUI/CashShop/CSBeauty/hairColor/Disable/2#"
var s3 = "#fUI/CashShop/CSBeauty/hairColor/Disable/3#"
var s4 = "#fUI/CashShop/CSBeauty/hairColor/Disable/4#"
var s5 = "#fUI/CashShop/CSBeauty/hairColor/Disable/5#"
var s6 = "#fUI/CashShop/CSBeauty/hairColor/Disable/6#"
var s7 = "#fUI/CashShop/CSBeauty/hairColor/Disable/7#"
var a27 = "#fItem/Pet/5002511.img/stand0/0#";//
var a28 = "#fItem/Pet/5002511.img/stand1/2#";//
var a29 = "#fItem/Pet/5000187.img/stand0/0#";//
var a30 = "#fItem/Pet/5000491.img/stand0/0#";//
var a31 = "#fItem/Pet/5000416.img/stand0/0#";//
var a32 = "#fItem/Pet/5000416.img/stand0/0#";//
var a33 = "#fEffect/CharacterEff/1050334/1/1#"//
var f1 = "#fUI/CashShop/CSBeauty/hairColor/Enable/0#"
var f1 = "#fUI/CashShop/CSBeauty/hairColor/Enable/1#"
var f2 = "#v3801307#"
var f3 = "#v3801312#"
var f4 = "#v3801310#"
var f5 = "#v3801311#"
var f6 = "#fUI/CashShop/CSBeauty/hairColor/Enable/6#"
var f7 = "#fUI/CashShop/CSBeauty/hairColor/Enable/7#"

var qq1 = "#v3801312#"//家人冒險島
var qq2 = "#v3801315#"
var qq3 = "#v3801312#"
var qq4 = "#v3801313#"
var qq5 = "#v3801314#"
var qq6 = "#v3801316#"
var fengye = "#v3801309#"

var eff13 = "#fCharacter/PetEquip/01802690.img/info/iconRaw#"; //1
var guaji = "#fCharacter/PetEquip/01802667.img/info/iconRaw#"; //
var zanzhu = "#fCharacter/PetEquip/01802561.img/info/iconRaw#"; //
var bianli = "#fCharacter/PetEquip/01802466.img/info/iconRaw#"; //
var lanse = "#fCharacter/PetEquip/01802380.img/info/iconRaw#"; //
var huangse = "#fCharacter/PetEquip/01802381.img/info/iconRaw#"; //
var zise = "#fCharacter/PetEquip/01802382.img/info/iconRaw#"; //
var addOnlines = 0;
var sss = "";
let logName = 'wn'

if (player.hasItem(5064300, 1)) {
    player.loseItem(5064300)
}
start();
function start() {
    // 判断是否是黑暗势力攻城事件地图id
    if (map.getId() == 270000100) {
        let YN = npc.askYesNo("是否现在离开这里？")
        if (YN) {
            let key = event.getVariable("key");
            player.resetEventValue(key)
            player.changeMap(100000000);
        }
        return;
    }
}
let thisMapId = player.getMapId();
let notMapIds = [
    350060300, 105300303, 450004000, 450007240, 160000000, 450009301, 450012200, 450011990,
    450012500, 410000670, 410005005, 410005005, 410006020, 410006060, 410006080, 410006040, 410006000, 410007025
];


if (map.getId() == 180000001 || map.getId() == 749088007 || map.getId() == 749088008) {
    player.dropAlertNotice("因為非法操作被監禁play，詳情請詢問管理員。");
} else if (notMapIds.includes(thisMapId)) {
    player.showSystemMessage("請前往其他區域使用。");
} else {



    var tb = "\t \r\n"


    //tb+=" " + a27 + "       #r#e#fs18#-功能清單-#n #fs0#       " + a28 + "\n\r"
    tb += "#fs12##r#L0#" + "便捷傳送#l#L1#" + "副本中心#l#L6#" + "首領傳送#l#L3#" + "轉職#l\r\n\r\n"
    // tb+=\r\n\r\n"
    // tb+="#fs12##r#L5#" + fengye + "福利中心#l#L57#" + fengye + "商店列表#l#L3#" + fengye + "快速轉職#l#L61#" + fengye + "交易平台#l\r\n\r\n"
    //tb+="#L55#>#r垃圾桶#b<#l #L56#>#r分解器#b<#l #L57#>#r商店列表#b<#l #L58#>#r第二職業#b<#l\r\n\r\n"  #L9#" + fengye + "攻略指南#l
    //tb+="#fs12##b#L61#" + fengye + "王怪副本#l #L60#" + fengye + "野外王怪#l #L59#" + fengye + "週期副本#l\r\n\r\n"
    // tb+="#fs12##b#L8#" + fengye + "贊助中心#l#L24#" + fengye + "#b暖暖中心#l#L15#" + fengye + "綜合功能#l#L25#" + fengye + "限時活動#l\r\n\r\n "
    // if (player.isGm()) {
    //     tb += "#L1119#活動喇叭#l #L11119#限制道具#l #L111199#時裝改#l #L119#全服獎勵#l\r\n\r\n #L11991#飛行#l #L11992#刷怪怪卡#l #L11993#測試脚本#l\r\n"
    // }

    var selection = npc.askMenuS(tb, false);
}

//账号事件记录值
let msg_val = player.getEventValue("msg_check");

let type;
let a=0
//判断要不要验证手机
if (msg_val == 0 && (a>0)) {
    let txt = "  請選擇您需要的選項：(手機號驗證)\r\n";
    txt += "    #L1##r中國內陸#l        #L2#台灣#l\t\n\r\n";
    let sel = npc.askMenuS(txt);
    if (sel == 1) {
        // 大陆
        type = 1
    } else {
        // 台湾
        type = 2
    }
    tellPhoneIsWard();
} else {

    switch (selection) {
        case 101:

            player.runScript("刪除垃圾");
            break;
        case 11991:
            player.runScript("飛行");
            break;
        case 11993:
            player.runScript("金豬測試");
            break;
        case 11992:
            player.runScript("刷怪怪卡");
            break;

        case 55:

            player.runScript("刪除垃圾");
            break;
        case 56:

            player.runScript("裝備分解");
            break;
        case 57:
            if (map.getId() == 100000000 || map.getId() == 910000000) {
                player.runScript("shop");
            } else {
                npc.say("該項目只可以在射手村或者自由市場使用")
            }
            break;
        case 58:

            //	player.runScript( "副職業");
            break;
        case 59:

            player.runScript("每日任務");
            break;
        case 60:

            player.runScript("野外BOSS");
            break;
        case 61:
            if (map.getId() == 100000000 || map.getId() == 910000000) {
                player.runScript("交易網站");
            } else {
                npc.say("該項目只可以在射手村或者自由市場使用")
            }
            break;
        case 102:

            player.runScript("神魂回收");

            break;

        case 102:
            player.runScript("神魂回收");
            break;
        case 103:
            player.runScript("推薦中心");
            break;
        case 104:
            player.runScript("加油包");
            break;
        case 105:
            player.runScript("掉落查詢");
            break;

        case 11119:

            player.runScript("GM修改");
            break;

        case 111199:

            player.runScript("GM改時裝");
            break;


        case 78:

            player.runScript("外形管理");
            break;

        case 997:
            if (!player.isQuestCompleted(39014)) {
                var Care = [34218, 19031, 39013, 39014, 35942, 35937, 34905, 7707, 57185, 57186, 39439, 57102, 64215, 57156, 39510, 25512, 500763, 56553, 16909, 16880, 64011, 64010, 57452, 29900, 29001, 38074, 56568, 29002, 100468, 56956, 64591, 29003, 34901, 23220, 22603, 62395, 62396, 59030, 59031, 22602, 7107, 16018, 16020, 16022, 16024, 16026, 16028, 36102, 2646, 17035, 34965, 32240, 32241, 32242, 32243, 32244, 32245, 32246, 3199, 57400, 57461];
                for (var ii in Care) {
                    player.completeQuest(Care[ii], 0);
                }
                npc.say("已幫您消除任務前置，請重新點擊");
                break;
            } else {
                player.runNpc("chewchew_HungryMutoEnter");
                break;
            }

        case 998:

            player.runNpc("morasMO_Enter");
            break;

        case 15:


            //if (map.getId() == 100000000||map.getId() == 910000000) {
            player.runScript("便民服務");
            // }else{
            //     npc.say("該項目只可以在射手村或者自由市場使用")
            //  }
            break;


        case 0:

            player.runScript("chuansong");
            break;
        case 1119:

            player.runScript("GM喇叭");
            break;

        case 111119:
            text = "輸入"
            var quantity = npc.askNumber(text, 0, 1, 100);
            player.completeQuest(quantity, 0);
            break;
        case 79:

            player.runScript("機器人外形");
            break;
        case 1:

            player.runScript("每日任務");
            break;

        case 119:
            player.runScript("全服獎勵");
            break;
        case 2:
            player.runScript("個人信息");
            break;
        case 3:
            player.runScript("changeJob");
            break;
        case 4:
            if (!player.isQuestCompleted(6500)) {
                player.completeQuest(6500, 0);
            }
            player.changeMap(910000000);
            break;
        case 5:

            player.runScript("可領取獎勵");
            break;

        case 6:

            player.runScript("新BOSS傳送");
            break;

        case 7:
            npc.say("猴急")
            break;

        case 8:

            player.runScript("贊助系統");

            break;

        case 9:

            player.runScript("坐牢指南");
            break;

        case 10:

            player.runScript("開始掛機");
            break;



        case 12:
            player.runScript("坐牢指南");
            break;

        case 13:

            player.runScript("超值禮包");
            break;

        case 14:

            player.runScript("yjhg");
            break;



        case 16:

            player.runScript("劇情任務");
            break;

        case 17:

            player.runScript("tsxt");
            break;

        case 18:

            player.runScript("yjsc");
            break;

        case 19:

            player.runScript("wqpg");
            break;

        case 20://

            player.runScript("活動暫停");
            break;

        case 21:

            player.runScript("餘額禮包商店");
            break;
        case 22:

            player.runScript("BOSS傳送");
            break;
        case 23:

            player.runScript("排行榜");
            break;

        case 24:
            player.runScript("搜索時裝");
            //player.runScript("自選時裝");
            break;

        case 25:

            player.runScript("各種活動");
            break;

        case 911:

            player.runScript("裝備評分");
            break;
        case 912:

            player.runScript("個人信息");
            break;
        case 913:
            //cm.sendOk("暫時關閉.");

            player.runScript("門派相爭");
            break;
        case 914:

            player.runScript("裝備製作中心");
            break;
        case 11:
            player.runScript("網頁UI");
            break;
        /*var time=player.getOnlineTime()
        if(time<120||hour!==21||player.getEventValue("九點低保")>0){
        npc.say("#b抱歉，您需要滿足以下條件才可以領取：\r\n#r1.需要保持在X120分鐘以上，您當前當前在X："+time+"\r\n#b2.賬號只能領取一次\r\n#r3.只有21：00~21：59可以領取，當前時段："+hour+"")
        }else{
        player.addEventValue("九點低保")
        player.gainItem(5060048,1)
        player.gainItem(5060086,1)
        npc.broadcastNotice("[九點低保] : 恭喜 " + player.getName() + " 領取了今日低保福利。");
        npc.say("#r元旦快樂！這是給您的獎勵：\r\n#v5060048#*1  #v5060086#*1")
        }
        break;*/
        case 1112:
            player.runScript("payurl");
            break;
        case 1113:

            player.runScript("yjsc");
            break;
        case 789:

            player.runScript("libao");
            break;
        case 1001:

            player.changeMap(993120400);
            break;
    }

}



function getHyPay(type) {


    /*
    var sql = "select * from hypayxs where accname = '" + getAccountName() + "'";
    var push = player.customSqlResult(sql);
    if (push.size() == 0) {
        player.customSqlInsert("INSERT INTO `hypayxs` (`accname`, `name`) VALUES ('" + getAccountName() + "', '" + player.getName() + "')");
    }
    sql = "select * from hypayxs1 where accname = '" + getAccountName() + "'";
    push = player.customSqlResult(sql);
    if (push.size() == 0) {
        player.customSqlInsert("INSERT INTO `hypayxs1` (`accname`, `name`) VALUES ('" + getAccountName() + "', '" + player.getName() + "')");
    }
    */

    var sql = "select * from hypay where accname = '" + getAccountName() + "'";
    var push = player.customSqlResult(sql);
    if (push.size() > 0) {
        var result = push.get(0);
        if (type == 1) {
            var pay = result.get("pay");
        } else if (type == 2) {
            var pay = result.get("payUsed");
        } else if (type == 3) {
            var pay = result.get("payReward");
        }
    } else {
        player.customSqlInsert("INSERT INTO `hypay` (`accname`, `name`) VALUES ('" + getAccountName() + "', '" + player.getName() + "')");
        return getHyPay(1);
    }

    return pay;
}

function getAccountName() {
    var i = -1;
    var sql = "select name,id from accounts where id=" + player.getAccountId() + " order by name limit 1;";
    var push = player.customSqlResult(sql);
    if (push.size() > 0) {
        var result = push.get(0);
        var name = result.get("name");
    }

    return name;
}

function gainHyPay(count) {
    var sql = "update hypay set pay =pay+? where accname = '" + getAccountName() + "';";
    player.customSqlUpdate(sql, count);
    addXJDlog(count, 1)
}

/**
 * @param count  金额
 * @param type   货币1现金点2绑定
 */
function addXJDlog(count, type) {
    let accid = player.getAccountId();
    let name = getAccountName();
    let juesName = player.getName();
    let jueseID = player.getId();
    let log;
    if (count > 0) {
        if (type == 1) {
            log = '获取到了' + count + '现金点'
        } else {
            log = '获取到了' + count + '绑定点'
        }
    } else {
        if (type == 1) {
            log = '消费了' + count + '现金点'
        } else {
            log = '消费了' + count + '绑定点'
        }
    }
    let yue = getHyPay(type)
    let sql = "INSERT INTO xianjingdian_log (aid, aname, cid, cname, npcid, war, log, time, type, balance) VALUES ( " + accid + ", '" + name + "', " + jueseID + ", '" + juesName + "','" + logName + "', " + count + ", '" + log + "',NOW(), " + type + ", " + yue + ");"
    player.customSqlResult(sql);

    function getHyPay(type) {
        let sql = "select * from hypay where accname = '" + getAccountName() + "'";
        let push = player.customSqlResult(sql);
        let pay = "";
        if (push.size() > 0) {
            let result = push.get(0);
            if (type == 1) {
                pay = result.get("pay");
            } else if (type == 2) {
                pay = result.get("payUsed");
            } else if (type == 3) {
                pay = result.get("Cumulative");
            } else if (type == 8) {
                pay = result.get("bangding");
            }
        } else {
            player.customSqlInsert("INSERT INTO `hypay` (`accname`, `name`) VALUES ('" + getAccountName() + "', '" + player.getName() + "')");
            return getHyPay(1);
        }
        return pay;
    }
    function getAccountName() {
        let i = -1;
        let sql = "select name,id from accounts where id=" + player.getAccountId() + " order by name limit 1;";
        let push = player.customSqlResult(sql);
        let name = "";
        if (push.size() > 0) {
            let result = push.get(0);
            name = result.get("name");
        }
        return name;
    }
}


function getAccountName() {
    var i = -1;
    var sql = "select name,id from accounts where id=" + player.getAccountId() + " order by name limit 1;";
    var push = player.customSqlResult(sql);
    if (push.size() > 0) {
        var result = push.get(0);
        var name = result.get("name");
    }

    return name;
}

function checkDouble() {
    var date1 = new Date();
    var week1 = date1.getDay();
    var hour1 = date1.getHours();
    if (week1 == doubleWeek && hour1 == doubleHour) return true;
    return false;
}

function format(val) {
    var len = 0;
    for (var i = 0; i < val.length; i++) {
        var a = val.charAt(i);
        if (a.match("/[^\x00-\xff]/ig") != null) {
            len += 2;
        } else {
            len += 1;
        }
    }
    if (1 - len > 0) {
        for (var j = 1 - len; j > 0; j--) {
            val += " ";
        }
    } else {
        val = val.substring(0, val.length - 4);
        val += "萬"
        format(val);
    }
    return val;
}


function getAccount() {
    var i = -1;
    var sql = "select name,id,createdat from accounts where id=" + player.getAccountId() + " order by name limit 1;";
    var push = player.customSqlResult(sql);
    if (push.size() > 0) {
        var result = push.get(0);
    }

    return result;
}
function online() {
    var i = -1;
    var sql = "SELECT Count(accounts.loggedin) FROM accounts WHERE accounts.loggedin = 3";
    var push = player.customSqlResult(sql);
    if (push.size() > 0) {
        var result = push.get(0);
        var name = result.get("Count(accounts.loggedin)");
    }

    return name;
}

// 手机号验证
function tellPhoneIsWard() {
    let info = query_tellPhone();
    //判断手机号是否有记录
    if (info != -1) {
        //有記錄並且手機號為空
        if (info.get("tellphone") == null && info.get("stas") == 0) {
            //手機號為空
            let phone_info = npc.askText("檢測到你還未進行手機驗證，請在下方輸入你的#b手機號#k\r\n\r\n#r（僅用於驗證，保護關鍵財產使用）#k1", "", 8, 15);
            if (!isNaN(phone_info)) {
                if (check_tellPhone(phone_info) == 2) {
                    npc.say("你的手機號已經綁定。請不要重複綁定。");
                } else {
                    //生個一個4位數驗證碼
                    let code = generateVerificationCode();
                    //發送驗證碼並保存驗證碼到數據庫
                    sendPMessage(1, code, phone_info, 0);
                    let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                    if (!isNaN(check_phone)) {
                        //判断验证码
                        if (check_phone == code) {
                            //更新手機號記錄
                            update_tellPhone(phone_info, code, 1);
                            player.addEventValue("msg_check", 1, 15);
                            npc.say("已經完成驗證，感謝您的配合。");
                        } else {
                            player.dropAlertNotice("請輸入正确的驗證碼");
                        }
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                }
            } else {
                player.dropAlertNotice("請輸入正确的手機號");
            }
        }

        //15天后验证码重复收。
        if (info.get("stas") == 2 && info.get("tellphone") != null) {
            let recordTime = new Date(info.get("codetime"));
            let currentTime = new Date();
            // 计算时间差（单位为毫秒）
            const timeDiff = currentTime.getTime() - recordTime.getTime();
            // 判断时间差是否大于3分钟（3分钟=180000毫秒）
            if (timeDiff > 180000) {
                let isCheck = npc.askYesNo("檢測到15天內你還未進行手機驗證,點擊確定接收驗證碼\r\n\r\n#r（僅用於驗證，保護關鍵財產使用）#k2");
                if (isCheck == 1) {
                    //生個一個4位數驗證碼
                    let code = generateVerificationCode();
                    //發送驗證碼並保存驗證碼到數據庫
                    sendPMessage(1, code, info.get("tellphone"), 2);
                    let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                    if (!isNaN(check_phone)) {
                        //判断验证码
                        if (check_phone == code) {
                            player.addEventValue("msg_check", 1, 15);
                            update_tellPhone(info.get("tellphone"), code, 1);
                            npc.say("已經完成驗證，感謝您的配合。");
                        } else {
                            player.dropAlertNotice("請輸入正确的驗證碼");
                        }
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                }
            } else {
                let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                if (!isNaN(check_phone)) {
                    //判断验证码
                    if (check_phone == info.get("code")) {
                        player.addEventValue("msg_check", 1, 15);
                        update_tellPhone(info.get("tellphone"), info.get("code"), 1);
                        npc.say("已經完成驗證，感謝您的配合。");
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                } else {
                    player.dropAlertNotice("請輸入正确的驗證碼");
                }
            }
        }

        //15天之後重複驗證
        if (info.get("stas") == 1 && info.get("tellphone") != null) {
            //player.addEventValue("msg_check", 1, 15);
            let isCheck = npc.askYesNo("檢測到15天內你還未進行手機驗證,點擊確定接收驗證碼\r\n\r\n#r（僅用於驗證，保護關鍵財產使用）#k3");
            if (isCheck == 1) {
                //生個一個4位數驗證碼
                // npc.say(1)
                let code = generateVerificationCode();
                //發送驗證碼並保存驗證碼到數據庫
                ///npc.say(2)
                sendPMessage(1, code, info.get("tellphone"), 2);
                //npc.say(3)
                let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                if (!isNaN(check_phone)) {
                    //判断验证码
                    if (check_phone == code) {
                        player.addEventValue("msg_check", 1, 15);
                        update_tellPhone(info.get("tellphone"), code, 1);
                        npc.say("已經完成驗證，感謝您的配合。");
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                } else {
                    player.dropAlertNotice("請輸入正确的驗證碼");
                }
            }
        }

        //有記錄並且手機驗證狀態為0
        if (info.get("stas") == 0) {
            let recordTime = new Date(info.get("codetime"));
            let currentTime = new Date();
            // 计算时间差（单位为毫秒）
            const timeDiff = currentTime.getTime() - recordTime.getTime();
            // 判断时间差是否大于3分钟（3分钟=180000毫秒）
            if (timeDiff > 180000) {
                //手機號為空
                let phone_info = npc.askText("檢測到你還未進行手機驗證，請在下方輸入你的#b手機號#k\r\n\r\n#r（僅用於驗證，保護關鍵財產使用）#k", "", 8, 15);
                if (!isNaN(phone_info)) {
                    //生個一個4位數驗證碼
                    let code = generateVerificationCode();
                    //發送驗證碼並保存驗證碼到數據庫
                    sendPMessage(1, code, phone_info, 0);
                    let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                    if (!isNaN(check_phone)) {
                        //判断验证码
                        if (check_phone == code) {
                            //更新手機號記錄
                            update_tellPhone(phone_info, code, 1);
                            player.addEventValue("msg_check", 1, 15);
                            npc.say("已經完成驗證，感謝您的配合。");
                        } else {
                            player.dropAlertNotice("請輸入正确的驗證碼");
                        }
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                } else {
                    player.dropAlertNotice("請輸入正确的手機號");
                }

                //如果沒有大於三分鐘，則不重複發驗證碼
            } else {
                let code = info.get("code");
                let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                if (!isNaN(check_phone)) {
                    //判断验证码
                    if (check_phone == code) {
                        //更新手機號記錄
                        update_tellPhone(info.get("tellphone"), code, 1);
                        player.addEventValue("msg_check", 1, 15);
                        npc.say("已經完成驗證，感謝您的配合。");
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                } else {
                    player.dropAlertNotice("請輸入正确的驗證碼");
                }
            }
        }

        //如果没有记录
    } else {
        //手機號為空
        let phone_info = npc.askText("檢測到你還未進行手機驗證，請在下方輸入你的#b手機號#k\r\n\r\n#r（僅用於驗證，保護關鍵財產使用）#k", "", 8, 11);
        if (!isNaN(phone_info)) {
            if (check_tellPhone(phone_info) == 2) {
                npc.say("你的手機號已經綁定。請不要重複綁定。");
            } else {
                //生個一個4位數驗證碼
                let code = generateVerificationCode();
                //将验证码先保存下来
                insert_tellPhone(phone_info, code);
                //發送驗證碼並保存驗證碼到數據庫
                sendPMessage(1, code, phone_info, 99);
                let check_phone = npc.askText("請輸入您手機收到的#r驗證碼#k：\r\n\r\n", "", 4, 4);
                if (!isNaN(check_phone)) {
                    //判断验证码
                    if (check_phone == code) {
                        //更新手機號記錄
                        update_tellPhone(phone_info, code, 1);
                        player.addEventValue("msg_check", 1, 15);
                        npc.say("已經完成驗證，感謝您的配合。");
                    } else {
                        player.dropAlertNotice("請輸入正确的驗證碼");
                    }
                } else {
                    player.dropAlertNotice("請輸入正确的驗證碼");
                }
            }
        } else {
            player.dropAlertNotice("請輸入正确的手機號");
        }

    }
}

/**
 * 發送驗證碼
 * @param {Object} mode
 * @param {Object} code
 * @param {Object} phone_info
 * @param {Object} statu
 */
function sendPMessage(mode, code, phone_info, statu) {
    if (mode == 1) {
        // 台湾  
        //npc.say(4)
        let url =
            `http://154.92.18.76:8081/api/user/mobile?type=${type}&mobile=${phone_info}&code=${code}`;

        npc.httpGet(url);

        if (statu != 99) {
            //更新驗證碼狀態

            update_tellPhone(phone_info, code, statu);
        }
    }
}

function check_tellPhone(tellphone) {
    let sql = "SELECT * FROM accounts_tellphone WHERE tellphone =  '" + tellphone + "';";
    let result = player.customSqlResult(sql);
    if (result.size() > 0) {
        //判斷是否是多號註冊
        if (result.size() >= 1) {
            return 2;
        } else {
            return 1;
        }
    } else {
        return 0;
    }
}

/**
 * 查詢手機號
 * @param {Object} account_id 賬號ID
 */
function query_tellPhone() {
    let sql = "SELECT * FROM accounts_tellphone WHERE accountname = '" + player.getAccountName() + "';";
    let result = player.customSqlResult(sql);
    if (result.size() > 0) {
        let info = result.get(0);
        return info;
    } else {
        return -1;
    }
}
//新增手机号
function insert_tellPhone(tellPhone, code) {
    // const sql = "INSERT INTO accounts_tellphone(accountname, accountid, tellphone, code, codetime) VALUES (?,?,?,?,?);"
    // player.customSqlInsert(sql,player.getAccountName(),player.getAccountId(),tellPhone,code,NOW());
    const sql = `INSERT INTO accounts_tellphone(accountname, accountid, tellphone, code, codetime)
	             VALUES ('${player.getAccountName()}', '${player.getAccountId()}', '${tellPhone}', ${code},  NOW())`;
    player.customSqlInsert(sql);
}
//更新操作
function update_tellPhone(tellPhone, code, stas) {
    var sql =
        `UPDATE accounts_tellphone SET tellphone = ?, code = ?,stas = ?, codetime = NOW() WHERE accountname = '${player.getAccountName()}'`;
    const flag = player.customSqlUpdate(sql, tellPhone, code, stas);
    if (flag > 0) {
        return true;
    } else {
        return false;
    }
}

// 生成4位数的验证码
function generateVerificationCode() {
    // 生成一个0到999之间的随机整数，并填充至3位数
    return Math.floor(Math.random() * (9999 - 1000) + 1000);
}

function sendPostRequest(url, postData) {
    return new Promise((resolve, reject) => {
        let xhr = new XMLHttpRequest();
        xhr.open("POST", url);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
                resolve(xhr.responseText);
            } else {
                reject({
                    status: xhr.status,
                    statusText: xhr.statusText
                });
            }
        };
        xhr.onerror = function () {
            reject({
                status: xhr.status,
                statusText: xhr.statusText
            });
        };
        xhr.send(postData);
    });
}

